name: Patch Kernel with WildKSU

on:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight
  push:
    paths:
      - 'firmware_*/**' # Trigger when new firmware files are uploaded
      - '.github/workflows/**'
    branches: [ master ]
  workflow_dispatch:
    inputs:
      firmware_dir:
        description: 'Manual override: Directory containing stock ROM files'
        required: false
      kernel_version:
        description: 'Manual override: Kernel version (e.g., 6.1.141)'
        required: false

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Auto-Detect Firmware Directory
        id: detect_fw
        run: |
          if [ -n "${{ github.event.inputs.firmware_dir }}" ]; then
            FW_DIR="${{ github.event.inputs.firmware_dir }}"
          else
            # Pick the lexicographically last directory starting with firmware_
            FW_DIR=$(ls -d firmware_* | sort -V | tail -n 1)
          fi
          echo "fw_dir=$FW_DIR" >> $GITHUB_OUTPUT
          echo "Detected Firmware Directory: $FW_DIR"

      - name: Download magiskboot
        run: |
          wget https://github.com/magojohnji/magiskboot-linux/raw/main/x86_64/magiskboot -O magiskboot
          chmod +x magiskboot

      - name: Unpack Stock Kernel and Detect Version
        id: detect_kver
        run: |
          FW_DIR="${{ steps.detect_fw.outputs.fw_dir }}"
          BOOT_IMG="${FW_DIR}/boot.img"
          if [ ! -f "$BOOT_IMG" ]; then
            echo "Error: $BOOT_IMG not found"
            exit 1
          fi
          
          ./magiskboot unpack "$BOOT_IMG"
          mv kernel kernel.stock
          
          # Extract kernel version (e.g., 6.1.141)
          K_VER=$(strings kernel.stock | grep "Linux version " | awk '{print $3}' | cut -d'-' -f1)
          echo "kver=$K_VER" >> $GITHUB_OUTPUT
          echo "Detected Stock Kernel Version: $K_VER"

      - name: Resolve WildKSU Latest Release
        id: resolve_wildksu
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          R_TAG=$(gh release list --repo WildKernels/GKI_KernelSU_SUSFS --limit 1 | awk '{print $3}')
          echo "tag=$R_TAG" >> $GITHUB_OUTPUT
          echo "Latest WildKSU Release: $R_TAG"

      - name: Download and Patch Kernel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          K_VER="${{ github.event.inputs.kernel_version || steps.detect_kver.outputs.kver }}"
          R_TAG="${{ steps.resolve_wildksu.outputs.tag }}"
          
          ASSET_NAME=$(gh release view "$R_TAG" --repo WildKernels/GKI_KernelSU_SUSFS --json assets --jq ".assets[] | select(.name | contains(\"$K_VER\") and contains(\"Normal\")) | .name" | head -n 1)
          
          if [ -z "$ASSET_NAME" ]; then
            echo "Error: Could not find asset matching $K_VER with 'Normal' variant in $R_TAG"
            exit 1
          fi
          
          echo "Downloading asset: $ASSET_NAME"
          gh release download "$R_TAG" --repo WildKernels/GKI_KernelSU_SUSFS --pattern "$ASSET_NAME"
          unzip "$ASSET_NAME" Image
          
          # Extract stock and wild versions for string matching
          export STOCK_VERSION=$(strings kernel.stock | grep "Linux version " | head -n 1)
          export WILD_VERSION=$(strings Image | grep "Linux version " | head -n 1)
          
          echo "Stock: $STOCK_VERSION"
          echo "Wild:  $WILD_VERSION"
          
          python3 -c "
import sys
import os

with open('Image', 'rb') as f:
    data = f.read()

old_str = os.environ['WILD_VERSION'].encode()
new_str = os.environ['STOCK_VERSION'].encode()

if old_str in data:
    if len(new_str) > len(old_str):
        print(f'Error: Stock string longer than Wild string.')
        sys.exit(0)
    
    new_str_padded = new_str + b'\x00' * (len(old_str) - len(new_str))
    new_data = data.replace(old_str, new_str_padded)
    with open('Image.patched', 'wb') as f:
        f.write(new_data)
    print('Kernel patched successfully.')
else:
    print('Error: Could not find version string.')
"
          if [ -f Image.patched ]; then
            mv Image.patched kernel
          else
            mv Image kernel
          fi

      - name: Repack boot.img
        run: |
          FW_DIR="${{ steps.detect_fw.outputs.fw_dir }}"
          BOOT_IMG="${FW_DIR}/boot.img"
          ./magiskboot repack "$BOOT_IMG" patched_boot.img

      - name: Update README with Latest Modules
        id: update_readme
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Fetch latest versions
          WILD_KSU_APP=$(gh release view --repo WildKernels/Wild_KSU --json tagName --jq .tagName)
          ZYGISK_NEXT=$(gh release view --repo Dr-TSNG/ZygiskNext --json tagName --jq .tagName)
          META_OVERLAY=$(gh release view --repo KernelSU-Modules-Repo/meta-overlayfs --json tagName --jq .tagName)
          SUSFS_MOD=$(gh release view --repo sidex15/susfs4ksu-module --json tagName --jq .tagName)
          
          # Update links in README.md using sed
          # Example matching: https://github.com/WildKernels/Wild_KSU/releases/tag/v3.0.0
          sed -i "s|github.com/WildKernels/Wild_KSU/releases/tag/[^)]*|github.com/WildKernels/Wild_KSU/releases/tag/$WILD_KSU_APP|g" README.md
          sed -i "s|github.com/Dr-TSNG/ZygiskNext/releases/tag/[^)]*|github.com/Dr-TSNG/ZygiskNext/releases/tag/$ZYGISK_NEXT|g" README.md
          sed -i "s|github.com/KernelSU-Modules-Repo/meta-overlayfs/releases/tag/[^)]*|github.com/KernelSU-Modules-Repo/meta-overlayfs/releases/tag/$META_OVERLAY|g" README.md
          sed -i "s|github.com/sidex15/susfs4ksu-module/releases/tag/[^)]*|github.com/sidex15/susfs4ksu-module/releases/tag/$SUSFS_MOD|g" README.md
          
          if git diff --exit-code README.md; then
            echo "No changes to README"
          else
            git add README.md
            git commit -m "Docs: Auto-update module versions to latest"
            git push origin master
          fi

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          K_VER="${{ steps.detect_kver.outputs.kver }}"
          TAG_NAME="release-$K_VER-$(date +'%Y.%m.%d-%H%M')"
          gh release create "$TAG_NAME" patched_boot.img \
            --title "Moto Edge 50 Neo Patched Boot ($K_VER)" \
            --notes "Patched with WildKSU $(strings kernel | grep 'Linux version ' | head -n 1)" \
            --latest