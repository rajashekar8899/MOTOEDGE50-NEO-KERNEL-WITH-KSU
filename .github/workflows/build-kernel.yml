name: Patch Kernel with WildKSU

on:
  workflow_dispatch:
    inputs:
      firmware_dir:
        description: 'Directory containing stock ROM files (e.g., firmware_V1UIS35H)'
        required: true
        default: 'firmware_V1UIS35H'
      kernel_version:
        description: 'Kernel version to use from WildKernels (e.g., 6.1.141)'
        required: true
        default: '6.1.141'
      release_tag:
        description: 'WildKernels release tag'
        required: true
        default: 'v2.0.0-r8'

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download magiskboot
        run: |
          wget https://github.com/magojohnji/magiskboot-linux/raw/main/x86_64/magiskboot -O magiskboot
          chmod +x magiskboot

      - name: Download WildKSU Kernel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # We search for the "Normal" variant of the specified kernel version
          # Note: Adjust variants (Bypass/Normal) if needed
          ASSET_NAME="${{ github.event.inputs.kernel_version }}-android14-2025-07-Normal-AnyKernel3.zip"
          gh release download ${{ github.event.inputs.release_tag }} --repo WildKernels/GKI_KernelSU_SUSFS --pattern "$ASSET_NAME"
          unzip "$ASSET_NAME" Image
          if [ ! -f Image ]; then
            echo "Error: Image not found in AnyKernel3.zip"
            exit 1
          fi

      - name: Extract and Match Kernel Version String
        run: |
          BOOT_IMG="${{ github.event.inputs.firmware_dir }}/boot.img"
          if [ ! -f "$BOOT_IMG" ]; then
            echo "Error: $BOOT_IMG not found"
            exit 1
          fi
          
          # Unpack stock boot.img to get stock kernel
          ./magiskboot unpack "$BOOT_IMG"
          mv kernel kernel.stock
          
          # Extract stock version string
          # Usually starts with 'Linux version '
          STOCK_VERSION=$(strings kernel.stock | grep "Linux version " | head -n 1)
          echo "Stock Kernel Version: $STOCK_VERSION"
          
          # Unpack WildKSU AnyKernel3.zip was already done in previous step (Image file)
          # We need to extract its version string too
          WILD_VERSION=$(strings Image | grep "Linux version " | head -n 1)
          echo "WildKSU Kernel Version: $WILD_VERSION"
          
          if [ "$STOCK_VERSION" != "$WILD_VERSION" ]; then
            echo "Versions differ! Attempting to patch WildKSU kernel string..."
            
            # Simple python script to patch the string in binary
            # This is safe ONLY if the new string is shorter or equal to the old one.
            # We'll pad with null bytes if shorter.
            python3 -c "
import sys
with open('Image', 'rb') as f:
    data = f.read()

old_str = b'${WILD_VERSION}'
new_str = b'${STOCK_VERSION}'

if old_str in data:
    if len(new_str) > len(old_str):
        print('Error: Stock version string is longer than WildKSU string. Cannot patch without shifting offsets.')
        sys.exit(0) # Continue anyway but notify
    
    # Pad new string with null bytes to match old length
    new_str_padded = new_str + b'\x00' * (len(old_str) - len(new_str))
    new_data = data.replace(old_str, new_str_padded)
    
    with open('Image.patched', 'wb') as f:
        f.write(new_data)
    print('Kernel patched successfully.')
else:
    print('Error: Could not find WildKSU version string in binary.')
"
            if [ -f Image.patched ]; then
              mv Image.patched Image
            fi
          else
            echo "Versions already match."
          fi

      - name: Patch boot.img
        run: |
          BOOT_IMG="${{ github.event.inputs.firmware_dir }}/boot.img"
          
          # magiskboot unpack produces a file named 'kernel'
          # We already have kernel.stock from previous step, but magiskboot needs 'kernel' file
          mv Image kernel
          
          # Repack to new_boot.img
          ./magiskboot repack "$BOOT_IMG" patched_boot.img
          
      - name: Upload Patched boot.img
        uses: actions/upload-artifact@v4
        with:
          name: patched-boot-${{ github.event.inputs.kernel_version }}
          path: patched_boot.img
